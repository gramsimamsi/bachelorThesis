<!DOCTYPE html>
<!-- saved from url=(0074)https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script async="" src="./con19_files/analytics.js.Download"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-84550302-1','auto');ga('send','pageview');</script><meta http-equiv="x-ua-compatible" content="IE=edge"><meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="description" content="Policy-based control for cloud native environments"><meta property="og:title" content="Kubernetes Admission Control"><meta property="og:type" content="documentation"><meta property="og:url" content="https://openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="Open Policy Agent"><meta property="og:description" content="Policy-based control for cloud native environments"><meta name="og:type" content="article"><meta name="og:image" content="https://openpolicyagent.org/img/logos/opa-horizontal-color.png"><meta name="og:image:alt" content="Open Policy Agent project logo"><meta name="og:image:type" content="image/png"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OpenPolicyAgent"><meta name="twitter:creator" content="@OpenPolicyAgent"><link rel="canonical" content="https://openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/"><link rel="shortcut icon" href="https://www.openpolicyagent.org/favicon.png" type="image/x-icon"><meta name="generator" content="Hugo 0.55.5"><title>Open Policy Agent | Kubernetes Admission Control</title><style class="anchorjs"></style><link rel="stylesheet" href="./con19_files/tocbot.css"><link rel="stylesheet" href="./con19_files/style.02b3abfa63a42aa7ef552431acba3cb0b5a4dee193e5ba530729c35b523f956b.css" integrity="sha256-ArOr+mOkKqfvVSQxrLo8sLWk3uGT5bpTBynDW1I/lWs="></head><body><div class="dashboard"><div class="dashboard-panel left has-background-white-bis is-hidden-mobile"><div class="dashboard-panel-header has-text-centered"><div class="dashboard-panel-header-logo"><a href="https://openpolicyagent.org/"><img src="./con19_files/opa-stacked-color.png"></a></div><div class="dropdown is-left"><div class="dropdown-trigger"><button class="button is-dark" aria-haspopup="true" aria-controls="dropdown-menu">
<span><strong>v0.10.7</strong></span>
<span class="tag latest-tag is-warning is-small has-text-weight-bold">older</span>
<span class="icon is-small"><i class="fas fa-angle-down" aria-hidden="true"></i></span></button></div><div class="dropdown-menu"><div class="dropdown-content"><a href="https://www.openpolicyagent.org/docs/latest" class="dropdown-item">v0.13.0
<span class="tag latest-tag is-success is-small has-text-weight-bold">latest</span></a>
<a href="https://www.openpolicyagent.org/docs/v0.12.2" class="dropdown-item">v0.12.2</a>
<a href="https://www.openpolicyagent.org/docs/v0.11.0" class="dropdown-item">v0.11.0</a>
<a href="https://www.openpolicyagent.org/docs/v0.10.7" class="dropdown-item">v0.10.7</a>
<a href="https://www.openpolicyagent.org/docs/edge" class="dropdown-item">edge</a></div></div></div></div><div class="dashboard-panel-content is-scrollable"><span class="docs-nav-title">Documentation</span>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7">Introduction</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/how-does-opa-work/">How Does OPA Work?</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/how-do-i-write-policies/">How Do I Write Policies?</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/how-do-i-test-policies/">How Do I Test Policies?</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/language-reference/">Language Reference</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/configuration/">Configuration Reference</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/rest-api/">REST API</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/deployments/">Deployments</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/bundles/">Bundles</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/status/">Status</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/decision-logs/">Decision Logs</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/monitoring/">Monitoring</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/discovery/">Discovery</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/security/">Security</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/plugins/">Plugins</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/comparison-to-other-systems/">Comparison to Other Systems</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/faq/">FAQ</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/rego-cheatsheet/">Rego Cheatsheet</a><hr class="docs-nav-hr"><span class="docs-nav-title">Tutorials</span>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/get-started/">Get started</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/docker-authorization/">Docker Authorization</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/http-api-authorization/">HTTP API Authorization</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/ssh-and-sudo-authorization/">SSH and sudo Authorization</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/kafka-authorization/">Kafka Authorization</a>
<a class="docs-nav-item is-active" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/">Kubernetes Admission Control</a><div class="toc"><ol class="toc-list "><li class="toc-list-item is-active-li"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#goals" class="toc-link node-name--H2  is-active-link">Goals</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#prerequisites" class="toc-link node-name--H2 ">Prerequisites</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#steps" class="toc-link node-name--H2 ">Steps</a><ol class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#1-start-kubernetes-recommended-admisson-controllers-enabled" class="toc-link node-name--H3 ">1. Start Kubernetes recommended Admisson Controllers enabled</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#2-create-a-new-namespace-to-deploy-opa-into" class="toc-link node-name--H3 ">2. Create a new Namespace to deploy OPA into</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#3-deploy-opa-on-top-of-kubernetes" class="toc-link node-name--H3 ">3. Deploy OPA on top of Kubernetes</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#4-define-a-policy-and-load-it-into-opa-via-kubernetes" class="toc-link node-name--H3 ">4. Define a policy and load it into OPA via Kubernetes</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#5-exercise-the-policy" class="toc-link node-name--H3 ">5. Exercise the policy</a></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#6-modify-the-policy-and-exercise-the-changes" class="toc-link node-name--H3 ">6. Modify the policy and exercise the changes</a></li></ol></li><li class="toc-list-item"><a href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#wrap-up" class="toc-link node-name--H2 ">Wrap Up</a></li></ol></div><a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/terraform/">Terraform Testing</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/ceph-authorization/">Ceph Authorization</a><hr class="docs-nav-hr"><span class="docs-nav-title">Guides</span>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/guides-identity/">Identity and User Attributes</a>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/docs/v0.10.7/guides-kubernetes-admission-control/">Kubernetes Admission Control</a><hr class="docs-nav-hr"><span class="docs-nav-title">Support</span>
<a class="docs-nav-item" href="https://www.openpolicyagent.org/support.html">Enterprise and Commercial</a></div></div><div class="dashboard-main is-scrollable"><nav class="navbar is-primary"><div class="navbar-brand is-hidden-tablet"><a class="navbar-item" href="https://openpolicyagent.org/"><img src="./con19_files/opa-icon-white.png"></a>
<a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="mobile-menu"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div class="navbar-menu is-hidden-tablet" id="mobile-menu"><div class="navbar-start"><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Documentation</span>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/">Introduction</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/how-does-opa-work/">How Does OPA Work?</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/how-do-i-write-policies/">How Do I Write Policies?</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/how-do-i-test-policies/">How Do I Test Policies?</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/language-reference/">Language Reference</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/configuration/">Configuration Reference</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/rest-api/">REST API</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/deployments/">Deployments</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/bundles/">Bundles</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/status/">Status</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/decision-logs/">Decision Logs</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/monitoring/">Monitoring</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/discovery/">Discovery</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/security/">Security</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/plugins/">Plugins</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/comparison-to-other-systems/">Comparison to Other Systems</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/faq/">FAQ</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/rego-cheatsheet/">Rego Cheatsheet</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Tutorials</span>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/get-started/">Get started</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/docker-authorization/">Docker Authorization</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/http-api-authorization/">HTTP API Authorization</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/ssh-and-sudo-authorization/">SSH and sudo Authorization</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/kafka-authorization/">Kafka Authorization</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/">Kubernetes Admission Control</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/terraform/">Terraform Testing</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/ceph-authorization/">Ceph Authorization</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Guides</span>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/guides-identity/">Identity and User Attributes</a>
<a class="navbar-item" href="https://www.openpolicyagent.org/docs/v0.10.7/guides-kubernetes-admission-control/">Kubernetes Admission Control</a></div><div class="navbar-end"><div class="navbar-item"><div class="buttons"><a class="button is-primary" href="https://github.com/open-policy-agent/opa" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="button is-primary" href="https://twitter.com/OpenPolicyAgent" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="button is-primary" href="https://blog.openpolicyagent.org/" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="button is-primary" href="https://slack.openpolicyagent.org/" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></div></div><div class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="https://github.com/open-policy-agent/opa" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="navbar-item" href="https://twitter.com/OpenPolicyAgent" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="navbar-item" href="https://blog.openpolicyagent.org/" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="navbar-item" href="https://slack.openpolicyagent.org/" target="_blank"><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></nav><article class="article"><div class="container"><section class="hero"><div class="hero-body"><p class="title is-size-1 is-size-2-mobile">Kubernetes Admission Control</p></div></section><section class="section"><div class="content" style="padding-bottom: 669.3px;"><p>In Kubernetes, <a href="https://kubernetes.io/docs/admin/admission-controllers/">Admission Controllers</a> enforce semantic validation of objects during create, update, and delete operations. With OPA you can enforce custom policies on Kubernetes objects without recompiling or reconfiguring the Kubernetes API server.</p><h2 id="goals">Goals<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#goals" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>This tutorial shows how to enforce custom policies on Kubernetes objects using OPA. In this tutorial, you will define admission control rules that prevent users from creating Kubernetes Ingress objects that violate the following organization policy:</p><ul><li>Ingress hostnames must be whitelisted on the Namespace containing the Ingress.</li><li>Two ingresses in different namespaces must not have the same hostname.</li></ul><h2 id="prerequisites">Prerequisites<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#prerequisites" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>This tutorial requires Kubernetes 1.9 or later. To run the tutorial locally, we recommend using <a href="https://kubernetes.io/docs/getting-started-guides/minikube">minikube</a> in version <code>v0.28+</code> with Kubernetes 1.10 (which is the default).</p><h2 id="steps">Steps<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#steps" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h2><h3 id="1-start-kubernetes-recommended-admisson-controllers-enabled">1. Start Kubernetes recommended Admisson Controllers enabled<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#1-start-kubernetes-recommended-admisson-controllers-enabled" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h3><p>To implement admission control rules that validate Kubernetes resources during create, update, and delete operations, you must enable the <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook">ValidatingAdmissionWebhook</a> when the Kubernetes API server is started. The ValidatingAdmissionWebhook admission controller is included in the <a href="https://kubernetes.io/docs/admin/admission-controllers/#is-there-a-recommended-set-of-admission-controllers-to-use">recommended set of admission controllers to enable</a></p><p>Start minikube:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">minikube start</code></pre></div><p>Make sure that the minikube ingress addon is enabled:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">minikube addons <span style="color:#204a87">enable</span> ingress</code></pre></div><h3 id="2-create-a-new-namespace-to-deploy-opa-into">2. Create a new Namespace to deploy OPA into<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#2-create-a-new-namespace-to-deploy-opa-into" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h3><p>When OPA is deployed on top of Kubernetes, policies are automatically loaded out of ConfigMaps in the <code>opa</code> namespace.</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create namespace opa</code></pre></div><p>Configure <code>kubectl</code> to use this namespace:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl config set-context opa-tutorial --user minikube --cluster minikube --namespace opa
kubectl config use-context opa-tutorial</code></pre></div><h3 id="3-deploy-opa-on-top-of-kubernetes">3. Deploy OPA on top of Kubernetes<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#3-deploy-opa-on-top-of-kubernetes" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h3><p>Communication between Kubernetes and OPA must be secured using TLS. To configure TLS, use <code>openssl</code> to create a certificate authority (CA) and certificate/key pair for OPA:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl genrsa -out ca.key <span style="color:#0000cf;font-weight:700">2048</span>
openssl req -x509 -new -nodes -key ca.key -days <span style="color:#0000cf;font-weight:700">100000</span> -out ca.crt -subj <span style="color:#4e9a06">"/CN=admission_ca"</span></code></pre></div><p>Generate the TLS key and certificate for OPA:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat &gt;server.conf <span style="color:#4e9a06">&lt;&lt;EOF
</span><span style="color:#4e9a06">[req]
</span><span style="color:#4e9a06">req_extensions = v3_req
</span><span style="color:#4e9a06">distinguished_name = req_distinguished_name
</span><span style="color:#4e9a06">[req_distinguished_name]
</span><span style="color:#4e9a06">[ v3_req ]
</span><span style="color:#4e9a06">basicConstraints = CA:FALSE
</span><span style="color:#4e9a06">keyUsage = nonRepudiation, digitalSignature, keyEncipherment
</span><span style="color:#4e9a06">extendedKeyUsage = clientAuth, serverAuth
</span><span style="color:#4e9a06">EOF</span></code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl genrsa -out server.key <span style="color:#0000cf;font-weight:700">2048</span>
openssl req -new -key server.key -out server.csr -subj <span style="color:#4e9a06">"/CN=opa.opa.svc"</span> -config server.conf
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days <span style="color:#0000cf;font-weight:700">100000</span> -extensions v3_req -extfile server.conf</code></pre></div><blockquote><p>Note: the Common Name value you give to openssl MUST match the name of the OPA service created below.</p></blockquote><p>Create a Secret to store the TLS credentials for OPA:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create secret tls opa-server --cert<span style="color:#ce5c00;font-weight:700">=</span>server.crt --key<span style="color:#ce5c00;font-weight:700">=</span>server.key</code></pre></div><p>Next, use the file below to deploy OPA as an admission controller.</p><p><strong><code>admission-controller.yaml</code></strong>:</p><pre><code># Grant OPA/kube-mgmt read-only access to resources. This lets kube-mgmt
# replicate resources into OPA so they can be used in policies.
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: opa-viewer
roleRef:
  kind: ClusterRole
  name: view
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: Group
  name: system:serviceaccounts:opa
  apiGroup: rbac.authorization.k8s.io
---
# Define role for OPA/kube-mgmt to update configmaps with policy status.
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: opa
  name: configmap-modifier
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["update", "patch"]
---
# Grant OPA/kube-mgmt role defined above.
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: opa
  name: opa-configmap-modifier
roleRef:
  kind: Role
  name: configmap-modifier
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: Group
  name: system:serviceaccounts:opa
  apiGroup: rbac.authorization.k8s.io
---
kind: Service
apiVersion: v1
metadata:
  name: opa
  namespace: opa
spec:
  selector:
    app: opa
  ports:
  - name: https
    protocol: TCP
    port: 443
    targetPort: 443
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    app: opa
  namespace: opa
  name: opa
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opa
  template:
    metadata:
      labels:
        app: opa
      name: opa
    spec:
      containers:
        # WARNING: OPA is NOT running with an authorization policy configured. This
        # means that clients can read and write policies in OPA. If you are
        # deploying OPA in an insecure environment, be sure to configure
        # authentication and authorization on the daemon. See the Security page for
        # details: https://www.openpolicyagent.org/docs/security.html.
        - name: opa
          image: openpolicyagent/opa:0.10.7
          args:
            - "run"
            - "--server"
            - "--tls-cert-file=/certs/tls.crt"
            - "--tls-private-key-file=/certs/tls.key"
            - "--addr=0.0.0.0:443"
            - "--addr=http://127.0.0.1:8181"
          volumeMounts:
            - readOnly: true
              mountPath: /certs
              name: opa-server
        - name: kube-mgmt
          image: openpolicyagent/kube-mgmt:0.8
          args:
            - "--replicate-cluster=v1/namespaces"
            - "--replicate=extensions/v1beta1/ingresses"
      volumes:
        - name: opa-server
          secret:
            secretName: opa-server
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: opa-default-system-main
  namespace: opa
data:
  main: |
    package system

    import data.kubernetes.admission

    main = {
      "apiVersion": "admission.k8s.io/v1beta1",
      "kind": "AdmissionReview",
      "response": response,
    }

    default response = {"allowed": true}

    response = {
        "allowed": false,
        "status": {
            "reason": reason,
        },
    } {
        reason = concat(", ", admission.deny)
        reason != ""
    }
</code></pre><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f admission-controller.yaml</code></pre></div><p>When OPA starts, the <code>kube-mgmt</code> container will load Kubernetes Namespace and Ingress objects into OPA. You can configure the sidecar to load any kind of Kubernetes object into OPA. The sidecar establishes watches on the Kubernetes API server so that OPA has access to an eventually consistent cache of Kubernetes objects.</p><p>Next, generate the manifest that will be used to register OPA as an admission controller:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat &gt; webhook-configuration.yaml <span style="color:#4e9a06">&lt;&lt;EOF
</span><span style="color:#4e9a06">kind: ValidatingWebhookConfiguration
</span><span style="color:#4e9a06">apiVersion: admissionregistration.k8s.io/v1beta1
</span><span style="color:#4e9a06">metadata:
</span><span style="color:#4e9a06">  name: opa-validating-webhook
</span><span style="color:#4e9a06">webhooks:
</span><span style="color:#4e9a06">  - name: validating-webhook.openpolicyagent.org
</span><span style="color:#4e9a06">    rules:
</span><span style="color:#4e9a06">      - operations: ["CREATE", "UPDATE"]
</span><span style="color:#4e9a06">        apiGroups: ["*"]
</span><span style="color:#4e9a06">        apiVersions: ["*"]
</span><span style="color:#4e9a06">        resources: ["*"]
</span><span style="color:#4e9a06">    clientConfig:
</span><span style="color:#4e9a06">      caBundle: $(cat ca.crt | base64 | tr -d '\n')
</span><span style="color:#4e9a06">      service:
</span><span style="color:#4e9a06">        namespace: opa
</span><span style="color:#4e9a06">        name: opa
</span><span style="color:#4e9a06">EOF</span></code></pre></div><p>The generated configuration file includes a base64 encoded representation of the CA certificate so that TLS connections can be established between the Kubernetes API server and OPA.</p><p>Finally, register OPA as an admission controller:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f webhook-configuration.yaml</code></pre></div><p>You can follow the OPA logs to see the webhook requests being issued by the Kubernetes API server:</p><pre><code>kubectl logs -l app=opa -c opa
</code></pre><h3 id="4-define-a-policy-and-load-it-into-opa-via-kubernetes">4. Define a policy and load it into OPA via Kubernetes<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#4-define-a-policy-and-load-it-into-opa-via-kubernetes" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h3><p>To test admission control, create a policy that restricts the hostnames that an ingress can use (<a href="https://github.com/open-policy-agent/opa/blob/master/docs/code/kubernetes-admission-control-validation/ingress-whitelist.rego">ingress-whitelist.rego</a>):</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000">package</span> <span style="color:#000">kubernetes</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">admission</span>

<span style="color:#000">import</span> <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">kubernetes</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">namespaces</span>

<span style="color:#000">deny</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">]</span> <span style="color:#000;font-weight:700">{</span>
    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">kind</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">kind</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">"Ingress"</span>
    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">operation</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">"CREATE"</span>
    <span style="color:#000">host</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">object</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">spec</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">rules</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">_</span><span style="color:#ce5c00;font-weight:700">].</span><span style="color:#000">host</span>
    <span style="color:#204a87;font-weight:700">not</span> <span style="color:#000">fqdn_matches_any</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">host</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">valid_ingress_hosts</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">msg</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">sprintf</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">"invalid ingress host %q"</span><span style="color:#000;font-weight:700">,</span> <span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">host</span><span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">)</span>
<span style="color:#000;font-weight:700">}</span>

<span style="color:#000">valid_ingress_hosts</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000;font-weight:700">{</span><span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:700">|</span>
    <span style="color:#000">whitelist</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">namespaces</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">namespace</span><span style="color:#ce5c00;font-weight:700">].</span><span style="color:#000">metadata</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">annotations</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#4e9a06">"ingress-whitelist"</span><span style="color:#ce5c00;font-weight:700">]</span>
    <span style="color:#000">hosts</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">split</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">whitelist</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">","</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">host</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">hosts</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">_</span><span style="color:#ce5c00;font-weight:700">]</span>
<span style="color:#000;font-weight:700">}</span>

<span style="color:#000">fqdn_matches_any</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">patterns</span><span style="color:#000;font-weight:700">)</span> <span style="color:#000;font-weight:700">{</span>
    <span style="color:#000">fqdn_matches</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">patterns</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">_</span><span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">)</span>
<span style="color:#000;font-weight:700">}</span>

<span style="color:#000">fqdn_matches</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:700">)</span> <span style="color:#000;font-weight:700">{</span>
    <span style="color:#000">pattern_parts</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">split</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">"."</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">pattern_parts</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#ce5c00;font-weight:700">]</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">"*"</span>
    <span style="color:#000">str_parts</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">split</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">"."</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">n_pattern_parts</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">count</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">pattern_parts</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">n_str_parts</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">count</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str_parts</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">suffix</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">trim</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">"*."</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">endswith</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">suffix</span><span style="color:#000;font-weight:700">)</span>
<span style="color:#000;font-weight:700">}</span>

<span style="color:#000">fqdn_matches</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:700">)</span> <span style="color:#000;font-weight:700">{</span>
    <span style="color:#204a87;font-weight:700">not</span> <span style="color:#000">contains</span><span style="color:#000;font-weight:700">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:700">,</span> <span style="color:#4e9a06">"*"</span><span style="color:#000;font-weight:700">)</span>
    <span style="color:#000">str</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">pattern</span>
<span style="color:#000;font-weight:700">}</span>
</code></pre></div><p>Store the policy in Kubernetes as a ConfigMap. By default kube-mgmt will try to load policies out of configmaps in the opa namespace OR configmaps in other namespaces labelled openpolicyagent.org/policy=rego.</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create configmap ingress-whitelist --from-file<span style="color:#ce5c00;font-weight:700">=</span>ingress-whitelist.rego</code></pre></div><p>The OPA sidecar will notice the ConfigMap and automatically load the policy into OPA.</p><h3 id="5-exercise-the-policy">5. Exercise the policy<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#5-exercise-the-policy" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h3><p>Create two new namespaces to test the Ingress policy.</p><p><strong>qa-namespace.yaml</strong>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>v1<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>kind<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>Namespace<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>metadata<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>annotations<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>ingress-whitelist<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">"*.qa.acmecorp.com,*.internal.acmecorp.com"</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>qa</code></pre></div><p><strong>production-namespace.yaml</strong>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>v1<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>kind<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>Namespace<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>metadata<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>annotations<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>ingress-whitelist<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">"*.acmecorp.com"</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>production</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f qa-namespace.yaml
kubectl create -f production-namespace.yaml</code></pre></div><p>Next, define two Ingress objects. One of the Ingress objects will be permitted
and the other will be rejected.</p><p><strong>ingress-ok.yaml</strong>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>extensions/v1beta1<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>kind<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>Ingress<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>metadata<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>ingress-ok<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>spec<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>rules<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>-<span style="color:#f8f8f8;text-decoration:underline"> </span>host<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>signin.acmecorp.com<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>http<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>paths<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>-<span style="color:#f8f8f8;text-decoration:underline"> </span>backend<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>serviceName<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>nginx<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>servicePort<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">80</span></code></pre></div><p><strong>ingress-bad.yaml</strong>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>extensions/v1beta1<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>kind<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>Ingress<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>metadata<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>ingress-bad<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>spec<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>rules<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>-<span style="color:#f8f8f8;text-decoration:underline"> </span>host<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>acmecorp.com<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>http<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>paths<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>-<span style="color:#f8f8f8;text-decoration:underline"> </span>backend<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>serviceName<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>nginx<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span>servicePort<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">80</span></code></pre></div><p>Finally, try to create both Ingress objects:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f ingress-ok.yaml -n production
kubectl create -f ingress-bad.yaml -n qa</code></pre></div><p>The second Ingress is rejected because its hostname does not match the whitelist in the <code>qa</code> namespace.</p><h3 id="6-modify-the-policy-and-exercise-the-changes">6. Modify the policy and exercise the changes<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#6-modify-the-policy-and-exercise-the-changes" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h3><p>OPA allows you to modify policies on-the-fly without recompiling any of the services that offload policy decisions to it.</p><p>To enforce the second half of the policy from the start of this tutorial you can load another policy into OPA that prevents Ingress objects in different namespaces from sharing the same hostname.</p><p><a href="https://github.com/open-policy-agent/opa/blob/master/docs/code/kubernetes-admission-control-validation/ingress-conflicts.rego">ingress-conflicts.rego</a>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000">package</span> <span style="color:#000">kubernetes</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">admission</span>

<span style="color:#000">import</span> <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">kubernetes</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">ingresses</span>

<span style="color:#000">deny</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">]</span> <span style="color:#000;font-weight:700">{</span>
    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">kind</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">kind</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">"Ingress"</span>
    <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">operation</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">"CREATE"</span>
    <span style="color:#000">host</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">object</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">spec</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">rules</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">_</span><span style="color:#ce5c00;font-weight:700">].</span><span style="color:#000">host</span>
    <span style="color:#000">ingress</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#000">ingresses</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">other_ns</span><span style="color:#ce5c00;font-weight:700">][</span><span style="color:#000">other_ingress</span><span style="color:#ce5c00;font-weight:700">]</span>
    <span style="color:#000">other_ns</span> <span style="color:#ce5c00;font-weight:700">!=</span> <span style="color:#000">input</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">namespace</span>
    <span style="color:#000">ingress</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">spec</span><span style="color:#ce5c00;font-weight:700">.</span><span style="color:#000">rules</span><span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">_</span><span style="color:#ce5c00;font-weight:700">].</span><span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#000">host</span>
    <span style="color:#000">msg</span> <span style="color:#000;font-weight:700">:</span><span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">sprintf</span><span style="color:#000;font-weight:700">(</span><span style="color:#4e9a06">"invalid ingress host %q (conflicts with %v/%v)"</span><span style="color:#000;font-weight:700">,</span> <span style="color:#ce5c00;font-weight:700">[</span><span style="color:#000">host</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">other_ns</span><span style="color:#000;font-weight:700">,</span> <span style="color:#000">other_ingress</span><span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">)</span>
<span style="color:#000;font-weight:700">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create configmap ingress-conflicts --from-file<span style="color:#ce5c00;font-weight:700">=</span>ingress-conflicts.rego</code></pre></div><p>The OPA sidecar annotates ConfigMaps containing policies to indicate if they
were installed successfully. Verify that the ConfigMap was installed successfully:</p><pre><code>kubectl get configmap ingress-conflicts -o yaml
</code></pre><p>Test that you cannot create an Ingress in another namespace with the same hostname as the one created earlier.</p><p><strong>staging-namespace.yaml</strong>:</p><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>v1<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>kind<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>Namespace<span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span>metadata<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>annotations<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>ingress-whitelist<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">"*.acmecorp.com"</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>name<span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>staging</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f staging-namespace.yaml</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create -f ingress-ok.yaml -n staging</code></pre></div><h2 id="wrap-up">Wrap Up<a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://www.openpolicyagent.org/docs/v0.10.7/kubernetes-admission-control/#wrap-up" style="font: 1em/1 anchorjs-icons; padding-left: 0.375em;"></a></h2><p>Congratulations for finishing the tutorial!</p><p>This tutorial showed how you can leverage OPA to enforce admission control
decisions in Kubernetes clusters without modifying or recompiling any
Kubernetes components. Furthermore, once Kubernetes is configured to use OPA as
an External Admission Controller, policies can be modified on-the-fly to
satisfy changing operational requirements.</p><p>For more information about deploying OPA on top of Kubernetes, see
<a href="https://www.openpolicyagent.org/docs/v0.10.7/deployments#kubernetes">Deployments - Kubernetes</a>.</p></div></section></div></article></div></div><script src="./con19_files/jquery.min.js.Download"></script><script src="./con19_files/tocbot.min.js.Download"></script><script src="./con19_files/app.52200c8b9c51c6669d7306cac7e256f095e7d97c4474fdbc879d280d69c92674.js.Download" integrity="sha256-UiAMi5xRxmadcwbKx+JW8JXn2XxEdP28h50oDWnJJnQ="></script><script src="./con19_files/anchor.min.js.Download"></script></body></html>